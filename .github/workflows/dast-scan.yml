name: DAST Security Scan

permissions:
  contents: read
  actions: read
  security-events: write

on:
  schedule:
    - cron: '0 2 * * 0'   # Weekly Sunday 2 AM UTC
  workflow_dispatch:

env:
  TARGET_URL: ${{ secrets.DAST_TARGET_URL || 'http://localhost:3000' }}

jobs:
  # ==================== OWASP ZAP FULL SCAN ====================
  zap-full-scan:
    name: OWASP ZAP Full Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: ${{ env.TARGET_URL }}
          cmd_options: '-a'          # Authenticated mode if needed
          allow_issue_writing: false # Keeps scan clean
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'

      - name: Upload SARIF report
        uses: github/codeql-action/upload-sarif@v4
        with:
          # Full Scan auto-generates this file
          sarif_file: zapfullscan.sarif

      - name: Upload ZAP HTML & JSON Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-reports
          path: |
            report.html
            report.json
            report.xml
            zapfullscan.sarif


  # ==================== API SECURITY TESTING ====================
  api-security-test:
    name: API Security Testing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Newman
        run: |
          npm install -g newman newman-reporter-htmlextra

      - name: Run API Security Tests
        continue-on-error: true
        run: |
          cat > api-tests.json << 'EOF'
          {
            "info": { "name": "API Security Tests" },
            "item": [
              {
                "name": "SQL Injection Test",
                "request": {
                  "method": "GET",
                  "url": "${{ env.TARGET_URL }}/api/user?id=1' OR '1'='1"
                }
              },
              {
                "name": "XSS Test",
                "request": {
                  "method": "POST",
                  "url": "${{ env.TARGET_URL }}/api/user",
                  "body": { "mode": "raw", "raw": "{\"name\":\"<script>alert('xss')</script>\"}" }
                }
              }
            ]
          }
          EOF
          newman run api-tests.json --reporters cli,htmlextra --reporter-htmlextra-export api-report.html

      - name: Upload API Report
        uses: actions/upload-artifact@v4
        with:
          name: api-security-report
          path: api-report.html


  # ==================== SECURITY HEADERS CHECK ====================
  security-headers:
    name: Security Headers Validation
    runs-on: ubuntu-latest

    steps:
      - name: Check Security Headers
        run: |
          RESPONSE=$(curl -I -s ${{ env.TARGET_URL }})
          REQUIRED_HEADERS=(
            "Strict-Transport-Security"
            "X-Content-Type-Options"
            "X-Frame-Options"
            "Content-Security-Policy"
            "X-XSS-Protection"
          )
          MISSING=()
          for H in "${REQUIRED_HEADERS[@]}"; do
            if ! echo "$RESPONSE" | grep -iq "$H"; then MISSING+=("$H"); fi
          done

          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "::warning::Missing headers: ${MISSING[*]}"
          else
            echo "All required headers present"
          fi


  # ==================== SUMMARY ====================
  summary:
    name: DAST Summary
    runs-on: ubuntu-latest
    needs: [zap-full-scan, api-security-test, security-headers]
    if: always()

    steps:
      - name: Write Summary
        run: |
          echo "## ðŸ›¡ï¸ DAST Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** ${{ env.TARGET_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Jobs Completed" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP ZAP Full Scan" >> $GITHUB_STEP_SUMMARY
          echo "- API Security Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Security Headers Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts and reports are available in the Actions run." >> $GITHUB_STEP_SUMMARY
