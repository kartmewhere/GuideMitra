name: DAST Security Scan

permissions:
  actions: read
  contents: read
  security-events: write
  
on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual trigger

env:
  TARGET_URL: ${{ secrets.DAST_TARGET_URL || 'http://localhost:3000' }}

jobs:
  # ==================== OWASP ZAP Scan ====================
  zap-scan:
    name: OWASP ZAP Full Scan
    runs-on: ubuntu-latest
    
    permissions:
     security-events: write
     actions: read
     contents: read

    steps:
     - name: Checkout code
       uses: actions/checkout@v4

     - name: ZAP Baseline Scan
       uses: zaproxy/action-baseline@v0.10.0
       with:
        target: ${{ env.TARGET_URL }}
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
        output_file: 'zap-results'

     - name: Upload ZAP Results (SARIF)
       uses: github/codeql-action/upload-sarif@v4
       if: always()
       with:
        sarif_file: zap-results.sarif


  # ==================== API Security Testing ====================
  api-security-test:
    name: API Security Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Install Dependencies
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra

      - name: Run API Security Tests
        continue-on-error: true
        run: |
          # Create test collection for API security
          cat > api-security-tests.json << 'EOF'
          {
            "info": {
              "name": "API Security Tests",
              "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
            },
            "item": [
              {
                "name": "SQL Injection Test",
                "request": {
                  "method": "GET",
                  "url": "${{ env.TARGET_URL }}/api/user?id=1' OR '1'='1"
                }
              },
              {
                "name": "XSS Test",
                "request": {
                  "method": "POST",
                  "url": "${{ env.TARGET_URL }}/api/user",
                  "body": {
                    "mode": "raw",
                    "raw": "{\"name\":\"<script>alert('xss')</script>\"}"
                  }
                }
              }
            ]
          }
          EOF
          
          newman run api-security-tests.json \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export api-security-report.html || true

      - name: Upload API Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-security-report
          path: api-security-report.html

  # ==================== SSL/TLS Configuration Check ====================
  ssl-check:
    name: SSL/TLS Security Check
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.target_url, 'https')
    
    steps:
      - name: SSL Labs Scan
        run: |
          echo "Checking SSL/TLS configuration..."
          
          # Install testssl.sh
          git clone --depth 1 https://github.com/drwetter/testssl.sh.git
          cd testssl.sh
          
          # Run SSL scan
          ./testssl.sh --severity HIGH ${{ env.TARGET_URL }} || true

  # ==================== Security Headers Check ====================
  security-headers:
    name: Security Headers Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Security Headers
        run: |
          echo "Checking security headers..."
          
          RESPONSE=$(curl -I -s ${{ env.TARGET_URL }})
          
          # Check for required headers
          HEADERS=(
            "Strict-Transport-Security"
            "X-Content-Type-Options"
            "X-Frame-Options"
            "Content-Security-Policy"
            "X-XSS-Protection"
          )
          
          MISSING_HEADERS=()
          
          for HEADER in "${HEADERS[@]}"; do
            if ! echo "$RESPONSE" | grep -i "$HEADER" > /dev/null; then
              MISSING_HEADERS+=("$HEADER")
            fi
          done
          
          if [ ${#MISSING_HEADERS[@]} -gt 0 ]; then
            echo "::warning::Missing security headers: ${MISSING_HEADERS[*]}"
          else
            echo "✅ All required security headers present"
          fi

  # ==================== Vulnerability Summary ====================
  vulnerability-summary:
    name: DAST Summary Report
    runs-on: ubuntu-latest
    needs: [zap-scan, api-security-test, security-headers]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## DAST Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ OWASP ZAP Scan: Completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ API Security Test: Completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Security Headers Check: Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** ${{ env.TARGET_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the individual job results for detailed findings." >> $GITHUB_STEP_SUMMARY

